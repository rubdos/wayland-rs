<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Protocol structure - The rusty wayland handbook</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="./intro.html">Introduction</a></li><li><a href="./wayland/intro.html"><strong>1.</strong> Wayland generalities</a></li><li><ul class="section"><li><a href="./wayland/structure.html" class="active"><strong>1.1.</strong> Protocol structure</a></li><li><a href="./wayland/p_core/intro.html"><strong>1.2.</strong> The Core protocol</a></li><li><ul class="section"><li><a href="./wayland/p_core/special.html"><strong>1.2.1.</strong> Special objects</a></li><li><a href="./wayland/p_core/compositor.html"><strong>1.2.2.</strong> The Compositor</a></li><li><a href="./wayland/p_core/shm.html"><strong>1.2.3.</strong> The SHM</a></li><li><a href="./wayland/p_core/shell.html"><strong>1.2.4.</strong> The Shell</a></li><li><a href="./wayland/p_core/subcompositor.html"><strong>1.2.5.</strong> The Subcompositor</a></li><li><a href="./wayland/p_core/seat.html"><strong>1.2.6.</strong> The Seats</a></li><li><a href="./wayland/p_core/output.html"><strong>1.2.7.</strong> The Outputs</a></li><li><a href="./wayland/p_core/data_device.html"><strong>1.2.8.</strong> The Data Device Manager</a></li></ul></li></ul></li><li><a href="./client/intro.html"><strong>2.</strong> Writing client apps</a></li><li><a href="./server/intro.html"><strong>3.</strong> Writing compositors</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title">The rusty wayland handbook</h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="./wayland/structure.html#wayland-protocol-structure" name="wayland-protocol-structure"><h1>Wayland protocol structure</h1></a>
<p>Before detailing the protocol contents, we need to have a look at its structure.</p>
<p>This is an asynchronous message-based protocol, with an object-oriented structure.</p>
<a class="header" href="./wayland/structure.html#objects-requests-and-events" name="objects-requests-and-events"><h2>Objects, requests and events</h2></a>
<p>Messages are exchanged between the client and the server via a common pool of objects. Each message
is associated to an object and can refer to other objects. Some messages can result in the creation
or the destruction of objects.</p>
<p>Messages from the client to the server are called <strong>requests</strong>, and messages from the server to the
client are called <strong>events</strong>.</p>
<blockquote>
<p><strong>Examples:</strong></p>
<ul>
<li>A client can have an object that represents the keyboard. This object will receive an event each
time the user presses or releases a key.</li>
<li>A client can have an object representing a surface on the screen. It can send a request to the
server to associate a buffer to this surface, to define its contents in terms of pixel values.</li>
</ul>
</blockquote>
<p>All objects are created by other objects, most of them via a request. The set of all living objects
in a wayland session can thus be organised as a tree, on top of which lives a special object named
<code>wl_display</code>.</p>
<a class="header" href="./wayland/structure.html#the-display-the-registry-and-the-globals" name="the-display-the-registry-and-the-globals"><h2>The display, the registry and the globals</h2></a>
<p>A client session starts with a single object: the <code>wl_display</code>. This object represents the
connection to the server, an remains alive until the end. This is the entry point of the wayland
protocol: from it instances of <code>wl_registry</code> can be created.</p>
<p>This registry is the real heart of the protocol. Upon creation, it will receive a stream of events
that list to the client the set of <strong>globals</strong> the server presents to it. And this registry
then allows the user to instantiate these global objects.</p>
<p>Globals are of two kind:</p>
<ul>
<li>Singleton globals, that represent a capability of the compositor
<ul>
<li><em>For example, <code>wl_shm</code> represents the capability to manipulate shared-memory buffers.</em></li>
</ul>
</li>
<li>Non-Singleton globals<sup class="footnote-reference"><a href="./wayland/structure.html#1">1</a></sup>, that reprensent a device the compositor has access to
<ul>
<li><em>For example, the compositor can advertise a <code>wl_output</code> for each screen connected to the
computer.</em></li>
</ul>
</li>
</ul>
<p>The second kind can appear and dissapear during a session, as devices are plugged or unplugged from
the computer.</p>
<p>In any case, the client can, from the registry, create any number of instances of each global, in
the form of concrete wayland objects.</p>
<p>In the end, this kind of hierachy can be expected:</p>
<pre><code class="language-text">+------------+      +-------------+      +---------------+      +------------+
| wl_display |-----&gt;| wl_registry |--+--&gt;| wl_compositor |--+--&gt;| wl_surface |
+------------+      +-------------+  |   +---------------+  |   +------------+
                                     |                      |
                                     |                      |   +------------+
                                     |                      +--&gt;| wl_surface |
                                     |                          +------------+
                                     |
                                     |   +--------+      +-------------+      +-----------+
                                     +--&gt;| wl_shm |-----&gt;| wl_shm_pool |--+--&gt;| wl_buffer |
                                     |   +--------+      +-------------+  |   +-----------+
                                     |                                    |
                                     |                                    |   +-----------+
                                     |                                    +--&gt;| wl_buffer |
                                     |                                        +-----------+
                                     |
                                     |   +---------+      +-------------+
                                     +--&gt;| wl_seat |-----&gt;| wl_keyboard |
                                         +---------+      +-------------+
</code></pre>
<p><em>(The details of what these objects are and do will come later, in the <a href="./wayland/p_core.html">core protocol</a> section.)</em></p>
<a class="header" href="./wayland/structure.html#protocol-extensions" name="protocol-extensions"><h2>Protocol extensions</h2></a>
<p>The set of objects and the list of their requests and events is defined in
<a href="https://cgit.freedesktop.org/wayland/wayland/tree/protocol/wayland.xml">an XML file</a>. This approach allows wayland protocl extensions to be defined easily.</p>
<p>A <strong>protocol extension</strong> is just another XML file, which defines another set of objects, some of
them being globals, and thus serving as the entry points for the protocol extension.</p>
<p>All compositors and clients are expected to fully implement the core protocol. However, nothing is
forced regarding extensions. A client knows that a server supports a given extension if the
global(s) it defines are advertised in the events of the registry. If they are not, then the
compositor does not support the extension and the client can act accordingly (falling back to using
only the core protocol, or erroring out if the extension is crucial to the program).</p>
<p>A compositor cannot force the clients to support an extension.</p>
<a class="header" href="./wayland/structure.html#api-versioning" name="api-versioning"><h2>API versioning</h2></a>
<p>The APIs defined by the protocol files are versioned as follows:</p>
<ul>
<li>Each global defines a sub-hierarchy of the objects that it can directly or indirectly create.
This whole hierarchy shares the same version number.</li>
<li>Every time a request or an event is added to an object, the whole hierarchy it belongs to has
its version bumped (but several modifications can be made in a single version bump).</li>
<li>A compositor advertises via the registry the maximum version of each global it supports, and
must support any previous version as well.</li>
<li>A client, when instanciating a global, can choose any version of it between 1 and the maximum
supported by the compositor.</li>
</ul>
<a class="header" href="./wayland/structure.html#error-handling" name="error-handling"><h2>Error handling</h2></a>
<p>Error handling in the wayland protocol is very simple: whenever the client misuses an object (often
sending a request with invalid arguments) it causes a protocol error. A protocol error is always
fatal, and the server will close the connection whenever one occurs.</p>
<p> </p>
<hr />
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Sorry for the lack of a better name...</p>
</div>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="./wayland/intro.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="./wayland/p_core/intro.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./wayland/intro.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./wayland/p_core/intro.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
